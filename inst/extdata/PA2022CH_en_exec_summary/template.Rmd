---
output:
  pdf_document:
    latex_engine: xelatex
always_allow_html: true
params:
  survey_dir: NULL
  real_estate_dir: NULL
  language: EN
  investor_name: investor
  portfolio_name: portfolio
  peer_group: pensionfund
  audit_data: NULL
  total_portfolio: NULL
  scenario_selected: NULL
  emissions_data: NULL
  results_portfolio: NULL
  peers_results_aggregated: NULL
  peers_results_individual: NULL
  indices_results_portfolio: NULL
  currency_exchange_value: NULL
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

survey_dir <- params$survey_dir
real_estate_dir <- params$real_estate_dir
investor_name <- params$investor_name
portfolio_name <- params$portfolio_name
peer_group <- params$peer_group
scenario_selected <- params$scenario_selected
currency_exchange_value <- params$currency_exchange_value

results_portfolio <- params$results_portfolio
peers_results_individual <- params$peers_results_individual
peers_results_aggregated <- params$peers_results_aggregated
indices_results_portfolio <- params$indices_results_portfolio
total_portfolio <- params$total_portfolio
audit_data <- params$audit_data

emissions_data <- NULL
```

---
title: Executive summary
subtitle:  |  
  | PACTA Climate Test Switzerland 2022
  | Results of `r investor_name`, portfolio: `r portfolio_name`
---

<!-- This lives in create_interactive_report as template but an example template could also live in the executive-summary package if we have example data to run it -->

<!--  Questions -->
<!--  1. where should the example charts for this one live? 'img' folder in  -->
<!--  'create_interactive_report' like for the report? Or in the standalone  -->
<!--  executive-summary package?   -->
<!--  2. Where will ES-specific calculations be performed (eg. alignment scores)? Inside of prep functions or as a  part of PACTA analysis?  -->

### Table of contents

### About PACTA Climate Test 2022

Text

### Measuring climate alignment

Text in 3 columns

### Equity & bonds module overview

Text

```{r diagram}
# the specific PACTA outputs that we need here are my guesses 
data_diagram <- prep_diagram(
  audit_data = audit_data,
  emissions_data = emissions_data
)
plot_diagram(data_diagram)
```
\newpage

## Equity & Bonds Module

### Current state (PACTA sectors)

#### Exposure to climate-relevant sectors & technologies as % of AUM

Text

```{r exposure}
# the specific PACTA outputs that we need here are my guesses 
data_green_brown_bars <- prep_green_brown_bars(
  results_portfolio = results_portfolio,
  scenario_selected = scenario_selected
)
plot_green_brown_bars(data_green_brown_bars)
```

```{r exposure_fossil}
# the specific PACTA outputs that we need here are my guesses 
data_fossil_bars <- prep_fossil_bars(
  results_portfolio = results_portfolio,
  peers_results_aggregated = peers_results_aggregated,
  indices_results_portfolio = indices_results_portfolio,
  scenario_selected = scenario_selected
)
plot_fossil_bars(data_fossil_bars)
```

### Current & future state (Power sector)

#### Current exposure vs. future alignment for Power sector

```{r scatter_bonds, out.width="50%"}
data_scatter_power <- prep_scatter(
  results_portfolio = results_portfolio,
  peers_results_aggregated = peers_results_aggregated,
  peers_results_individual = peers_results_individual,
  indices_results_portfolio = indices_results_portfolio,
  scenario_selected = scenario_selected,
  asset_class = "bonds"
)
# plot_scatter(data_scatter_power) +
#   patchwork::plot_annotation(
#     title = "Bonds",
#     theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 22))
#     )
```
Text

```{r scatter_equity, out.width="50%"}
# REMEMBER: we need an additional data point with average here
# the specific PACTA outputs that we need here are my guesses 
data_scatter_power <- prep_scatter(
  results_portfolio = results_portfolio,
  peers_results_aggregated = peers_results_aggregated,
  peers_results_individual = peers_results_individual,
  indices_results_portfolio = indices_results_portfolio,
  scenario_selected = scenario_selected,
  asset_class = "equity"
)
# plot_scatter(data_scatter_power) +
#   patchwork::plot_annotation(
#     title = "Equity",
#     theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 22))
#     )
```

### Future state (PACTA sectors)

#### Aggregated alignment scores

Text

```{r scores_equity}
# the specific PACTA outputs that we need here are my guesses 
data_scores <- prep_scores(
  results_portfolio = results_portfolio,
  peers_results_aggregated = peers_results_aggregated,
  asset_class = "equity"
)
plot_scores(data_scores) +
  patchwork::plot_annotation(
    title = "Equity",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 22))
    )
```

```{r scores_bonds}
# the specific PACTA outputs that we need here are my guesses 
data_scores <- prep_scores(
  results_portfolio = results_portfolio,
  peers_results_aggregated = peers_results_aggregated,
  asset_class = "bonds"
)
plot_scores(data_scores) +
  patchwork::plot_annotation(
    title = "Bonds",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 22))
    )
```

\newpage

## Equity & Bonds Module

### Future state (PACTA sectors)

#### Scenario alignment per technology

```{r alignment_table_bonds, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
data_alignment_table <- prep_alignment_table(
  results_portfolio = results_portfolio, 
  peers_results_aggregated = peers_results_aggregated,
  asset_class = "bonds"
)
plot_alignment_table(data_alignment_table)
# TODO: add title
```

Text

```{r alignment_table_equity, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
data_alignment_table <- prep_alignment_table(
  results_portfolio = results_portfolio, 
  peers_results_aggregated = peers_results_aggregated,
  asset_class = "equity"
)
plot_alignment_table(data_alignment_table)
# TODO: add title
```

\newpage

## Survey

Text
Text in a box
```{r plot_wordcloud, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_wordcloud.png"))
# TODO: add title
```

```{r plot_layer_with_peer_info_climate_goals, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_with_peer_info_climate_goals.png"))
# TODO: add title
```

### Overview

Text

### Investee engagement per sector

Text

```{r plot_layer_with_peer_info_engagement_Fossil_Fuels, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_with_peer_info_engagement_Fossil_Fuels.png"))
# TODO: add title - Power engagement badge.
```
```{r plot_layer_with_peer_info_engagement_Automotive, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_with_peer_info_engagement_Automotive.png"))
# TODO: add title - Automotive engagement badge.
```
```{r plot_layer_with_peer_info_engagement_Power, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_with_peer_info_engagement_Power.png"))
# TODO: add title - Fossil fuels engagement badge.
```

### Climate-aligned strategies and PACTA fossil fuel exposure

Text

```{r plot_layer_asset_exclusion_coal_Listed_equities, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_asset_exclusion_coal_Listed_equities.png"))
# TODO: add title - Coal exclusion badge - equity.
```

```{r exposure_survey_equity_coal, out.width="25%"}
# the specific PACTA outputs that we need here are my guesses 
data_exposures_survey <- prep_exposures_survey(results_portfolio, 
                                               peers_results_aggregated,
                                             sector = "coal",
                                             asset_class = "equity")
plot_exposures_survey(data_exposures_survey) +
  labs(subtitle = "Sectoral exposure\n(as % of AUM)")
```

```{r plot_layer_asset_exclusion_coal_Corporate_bonds, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_asset_exclusion_coal_Corporate_bonds.png"))
# TODO: add title - Coal exclusion badge - bonds.
```

```{r exposure_survey_bonds_coal, out.width="25%"}
# the specific PACTA outputs that we need here are my guesses 
data_exposures_survey <- prep_exposures_survey(results_portfolio,
                                               peers_results_aggregated,
                                             sector = "coal",
                                             asset_class = "bonds")
plot_exposures_survey(data_exposures_survey) +
  labs(subtitle = "Sectoral exposure\n(as % of AUM)")
```

```{r plot_layer_asset_exclusion_oil_Listed_equities, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_asset_exclusion_oil_Listed_equities.png"))
# TODO: add title - Oil exclusion badge - equity.
```

```{r exposure_survey_equity_oil_and_gas, out.width="25%"}
# the specific PACTA outputs that we need here are my guesses 
data_exposures_survey <- prep_exposures_survey(results_portfolio, 
                                               peers_results_aggregated,
                                             sector = "oil_and_gas",
                                             asset_class = "equity")
plot_exposures_survey(data_exposures_survey) +
  labs(subtitle = "Sectoral exposure\n(as % of AUM)")
```

```{r plot_layer_asset_exclusion_oil_Corporate_bonds, fig.height = 6}
# the specific PACTA outputs that we need here are my guesses 
knitr::include_graphics(file.path(survey_dir, language, "plot_layer_asset_exclusion_oil_Corporate_bonds.png"))
# TODO: add title - Oil exclusion badge - bonds.
```

```{r exposure_survey_bonds_oil_and_gas, out.width="25%"}
# the specific PACTA outputs that we need here are my guesses 
data_exposures_survey <- prep_exposures_survey(results_portfolio, 
                                               peers_results_aggregated,
                                             sector = "oil_and_gas",
                                             asset_class = "bonds")
plot_exposures_survey(data_exposures_survey) +
  labs(subtitle = "Sectoral exposure\n(as % of AUM)")
```

\newpage

## Real Estate & Mortgage Module

```{r real_estate_load_data}
real_estate_data <- jsonlite::read_json(
  path = file.path(real_estate_dir, "data", "data.json")
)[["exec_sum"]]

remove_list_null <- function(x){
  nulls <- which(sapply(x, is.null))
  if (length(nulls) > 0){
    x <- x[-nulls]
  }
  return(x)
}

convert_re_user_path <- function(
  wp_path,
  parent_dir = file.path(real_estate_dir, "img")
  ){
  filename <- basename(wp_path)
  return(file.path(parent_dir, filename))
}

real_estate_paths <- real_estate_data[["real_estate"]][[tolower(language)]]
cleaned_real_estate_paths <- real_estate_paths %>%
  remove_list_null %>%
  lapply(X = ., FUN = convert_re_user_path)
stopifnot(all(sapply(X = cleaned_real_estate_paths, FUN = file.exists)))

mortgage_paths <- real_estate_data[["mortgage"]][[tolower(language)]]
cleaned_mortgage_paths <- mortgage_paths %>%
  remove_list_null %>%
  lapply(X = ., FUN = convert_re_user_path)
stopifnot(all(sapply(X = cleaned_mortgage_paths, FUN = file.exists)))

```


### Current Status

Shares of energy sources compared to all participants 

Directly held buildings

```{r real_estate_bar_chart, fig.height = 6}
knitr::include_graphics(cleaned_real_estate_paths[["png_energy_carrier"]])
```

Geographical distribution of directly held buildings by use 

```{r real_estate_map, fig.height = 6}
knitr::include_graphics(cleaned_real_estate_paths[["png_map"]])
```

Mortgages 

```{r real_estate_mortgages_bar_chart, fig.height = 6}
knitr::include_graphics(cleaned_mortgage_paths[["png_energy_carrier"]])
```

Link für Hinweise auf mögliche physische Klimarisiken: 

Natural Hazards [https://map.geo.admin.ch/?topic=bafu&lang=en&bgLayer=ch.swisstopo.pixelkarte-grau&catalogNodes=825,826,843,849,851,1505]

Distribution of the average CO2 intensity of your real estate portfolio (directly held buildings) compared to peers. 

```{r real_estate_distribution, fig.height = 6}
knitr::include_graphics(cleaned_real_estate_paths[["png_co2_distribution"]])
```

Distribution of the mean CO2 intensity of your mortgage portfolio compared to peers. 

```{r mortgage_distribution, fig.height = 6}
knitr::include_graphics(cleaned_mortgage_paths[["png_co2_distribution"]])
```

### Future Status

Reduction path of all directly held buildings with the submitted refurbishment plans. 

```{r real_estate_reduction_path, fig.height = 6}
knitr::include_graphics(cleaned_real_estate_paths[["png_pathway"]])
```

Proportion of their mortgages that are above or below the reduction path for net zero by 2050

```{r real_estate_reduction_proportion, fig.height = 6}
knitr::include_graphics(cleaned_mortgage_paths[["png_stranded_asset"]])
```

\newpage

## Climate Score Card

### Current State

#### Carbon Emissions

Text

```{r emissions_scorecard}
# the specific PACTA outputs that we need here are my guesses 
data_emissions_scorecard <- prep_emissions_scorecard(emissions_data)
plot_emissions_scorecard(data_emissions_scorecard)
```

```{r emissions_scorecard_info}
total_portfolio_value_curr <- audit_data %>%
  dplyr::mutate(value_usd = dplyr::if_else(value_usd < 0, 0, value_usd)) %>%
  dplyr::mutate(value_curr = value_usd / currency_exchange_value) %>%
  dplyr::pull(value_curr) %>%
  sum(na.rm = TRUE)

total_portfolio_percentage_equity <- (audit_data %>%
  filter(asset_type == "Equity") %>%
  mutate(value_curr = value_usd/currency_exchange_value) %>%
  dplyr::pull(value_curr) %>%
  sum(na.rm =T)) /
  total_portfolio_value_curr

total_portfolio_percentage_bonds <- (audit_data %>%
  filter(asset_type == "Bonds") %>%
  mutate(value_curr = value_usd/currency_exchange_value) %>%
  dplyr::pull(value_curr) %>%
  sum(na.rm =T)) /
  total_portfolio_value_curr

total_portfolio_percentage_coverage <- (total_portfolio_percentage_equity + total_portfolio_percentage_bonds)
  
```
|Listed Equity |Corporate Bonds |
|:-------------|:---------------|
|iShares MSCI World ETF | iShares Global Corp Bond UCITS ETF |


Portfolio assets covered by assessment: **`r total_portfolio_percentage_coverage * 100` %**

#### Exposure to Fossil-fuel and other climate-relevant activities

Text

```{r exposures_scorecard}
# the specific PACTA outputs that we need here are my guesses 
data_exposures_scorecard <- prep_exposures_scorecard(results_portfolio)
plot_exposures_scorecard(data_exposures_scorecard)
```

### Transition to Net zero

#### Global Warming Alignment

Text

```{r scores_scorecard}
# the specific PACTA outputs that we need here are my guesses 
data_scores_scorecard <- prep_scores_scorecard(results_portfolio)
plot_scores_scorecard(data_scores_scorecard)

# TODO: needs to return actual scenario name
```

#### Verified Commitments to Net-Zero
```{r sbti_net_zero_commitments, fig.height = 6}
fin_data_net_zero_targets <- readr::read_csv(file.path(survey_dir, language, "fin_data_net_zero_targets.csv"))

peer_group_share_net_zero <- readr::read_csv(file.path(survey_dir, language, "peer_group_share_net_zero.csv"))

data_prep_net_zero_commitments <- prep_net_zero_commitments(
  total_portfolio = total_portfolio,
  peer_group = peer_group,
  net_zero_targets = fin_data_net_zero_targets,
  peer_group_share_net_zero = peer_group_share_net_zero
)

knitr::kable(data_prep_net_zero_commitments)
# TODO: add title - SBTI net zero commitments.
```

#### General Info

```{r general_info, fig.height = 6}
# TODO: add % emissions covered by assessment

```

Portfolio assets covered by assessment: **`r total_portfolio_percentage_coverage * 100` %**

Climate scenario used: **GECO 2021**


#### Overall Climate Strategy including Credible Climate Stewardship

```{r climate_strategy_initiatives, fig.height = 6}
user_climate_strategy_scorecard_initiatives <- readr::read_csv(file.path(survey_dir, language, "climate_scorecard_survey_initiatives.csv"))

peers_climate_strategy_scorecard_initiatives <- readr::read_csv(file.path(survey_dir, language, "peers_climate_scorecard_survey_initiatives.csv"))

data_prep_climate_strategy_scorecard_initiatives <- prep_climate_strategy_scorecard_initiatives(
  data = user_climate_strategy_scorecard_initiatives,
  data_peers = peers_climate_strategy_scorecard_initiatives,
  peer_group = peer_group
)

knitr::kable(data_prep_climate_strategy_scorecard_initiatives)
# TODO: add title - data_prep_climate_strategy_scorecard_initiatives.
```

```{r climate_strategy_voting_rights, fig.height = 6}
user_climate_strategy_scorecard_voting <- readr::read_csv(file.path(survey_dir, language, "climate_scorecard_survey_voting.csv"))

peers_climate_strategy_scorecard_voting <- readr::read_csv(file.path(survey_dir, language, "peers_climate_scorecard_survey_voting.csv"))

data_prep_climate_strategy_scorecard_voting <- prep_climate_strategy_scorecard_voting(
  data = user_climate_strategy_scorecard_voting,
  data_peers = peers_climate_strategy_scorecard_voting,
  peer_group = peer_group
)

knitr::kable(data_prep_climate_strategy_scorecard_voting)
# TODO: add title - data_prep_climate_strategy_scorecard_initiatives.
```

```{r climate_strategy_engagement, fig.height = 6}
user_climate_strategy_scorecard_engagement <- readr::read_csv(file.path(survey_dir, language, "climate_scorecard_survey_engagement.csv"))

peers_climate_strategy_scorecard_engagement <- readr::read_csv(file.path(survey_dir, language, "peers_climate_scorecard_survey_engagement.csv"))

data_prep_climate_strategy_scorecard_engagement <- prep_climate_strategy_scorecard_engagement(
  data = user_climate_strategy_scorecard_engagement,
  data_peers = peers_climate_strategy_scorecard_engagement,
  peer_group = peer_group
)

knitr::kable(data_prep_climate_strategy_scorecard_engagement)
# TODO: add title - data_prep_climate_strategy_scorecard_initiatives.
```


\newpage

## Annex (I): Detailed chart explanation

\newpage

## Annex (I): Detailed chart explanation

\newpage

## Annex (II): FAQs
